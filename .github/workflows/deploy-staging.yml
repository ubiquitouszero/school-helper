# Template: Auto-Deploy to Staging
# Automatically deploys to staging environment on push to master

name: Deploy to Staging

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allow manual triggers

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run linters
      run: |
        cd backend
        black --check .
        isort --check-only .
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: Run bandit security scan
      run: |
        cd backend
        bandit -r apps -c ../pyproject.toml -lll

  build-backend:
    runs-on: ubuntu-latest
    needs: lint-and-test
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push backend image
      uses: docker/build-push-action@v3
      with:
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/YOUR-APP-backend:${{ github.sha }}
          ghcr.io/${{ github.repository_owner }}/YOUR-APP-backend:staging-latest
        file: ./backend/Dockerfile
        context: ./backend
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-backend-staging:
    runs-on: ubuntu-latest
    needs: build-backend
    environment:
      name: 'staging'
      url: https://staging.your-domain.com  # CUSTOMIZE THIS

    steps:
    - name: Azure Login  # OR AWS/GCP login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Web App  # OR your cloud provider
      run: |
        az webapp config container set \
          --name YOUR-APP-backend-staging \
          --resource-group YOUR-RESOURCE-GROUP \
          --docker-custom-image-name ghcr.io/${{ github.repository_owner }}/YOUR-APP-backend:${{ github.sha }} \
          --docker-registry-server-url https://ghcr.io \
          --docker-registry-server-user ${{ github.repository_owner }} \
          --docker-registry-server-password ${{ secrets.GHCR_PAT }}

        az webapp restart --name YOUR-APP-backend-staging --resource-group YOUR-RESOURCE-GROUP

  smoke-tests:
    runs-on: ubuntu-latest
    needs: [deploy-backend-staging]
    steps:
    - name: Wait for deployment to settle
      run: sleep 30

    - name: Check backend health
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://staging.your-domain.com/health/ || echo "000")
        if [ "$response" != "200" ] && [ "$response" != "403" ]; then
          echo "Backend health check failed with status: $response"
          exit 1
        fi
        echo "Backend health check passed (status: $response)"

  notify:
    runs-on: ubuntu-latest
    needs: [lint-and-test, build-backend, deploy-backend-staging, smoke-tests]
    if: always()
    steps:
    - name: Notify Slack - Deployment Success
      if: ${{ needs.smoke-tests.result == 'success' }}
      run: |
        curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "✅ *Staging Deployment Successful*",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "✅ *Staging Deployment Successful*\n\n*Commit:* `${{ github.sha }}`\n*URL:* https://staging.your-domain.com"
                }
              }
            ]
          }'

    - name: Notify Slack - Deployment Failed
      if: ${{ needs.smoke-tests.result == 'failure' }}
      run: |
        curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "❌ *STAGING DEPLOYMENT FAILED*",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "❌ *STAGING DEPLOYMENT FAILED*\n\n*Commit:* `${{ github.sha }}`\n*Author:* ${{ github.actor }}\n*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                }
              }
            ]
          }'

# Customization Checklist:
# [ ] Replace YOUR-APP with your application name
# [ ] Replace YOUR-RESOURCE-GROUP with your resource group
# [ ] Update staging.your-domain.com with your domain
# [ ] Set up GitHub Secrets:
#     - AZURE_CREDENTIALS (or AWS/GCP equivalents)
#     - GHCR_PAT (GitHub Personal Access Token)
#     - SLACK_WEBHOOK_URL (optional)
# [ ] Adjust health check endpoint (/health/)
# [ ] Add frontend deployment if needed
