# ADR-0009: Authentication & QR Code Sign-In

**Status:** Proposed

**Date:** 2026-01-14

**Context:** School Helper needs authentication that works for both adults (parents, teachers) and children. Kids are used to QR codes for sign-in at school. We need to support both permanent QR codes for individual students and session codes for classroom activities (like Kahoot). Must comply with COPPA (no passwords for kids under 13) and work seamlessly across devices.

**Decision Drivers:**
- Kids are familiar with QR code sign-in from school
- No passwords for children under 13 (COPPA compliance)
- Adults need secure authentication for admin functions
- Teachers need quick way to get whole class signed in
- Must work on tablets (primary device for kids)
- Offline-first consideration for classroom use

## Decision

Implement a **dual authentication system**:

1. **Adults (Parents/Teachers):** Supabase Auth with email/password or magic links
2. **Students:** Two sign-in methods:
   - **Permanent QR Code** - Unique per student, generated by parent/teacher
   - **Session Code** - 6-digit code generated by teacher for class activities

### Authentication Flow Diagram

```
ADULT SIGN-IN
┌─────────────────────────────────────────┐
│ Email + Password  ──→ Supabase Auth     │
│ Magic Link        ──→ Supabase Auth     │
│ (Future: Google SSO, Clever)            │
└─────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────┐
│ adult_profiles (linked to auth.users)   │
└─────────────────────────────────────────┘

STUDENT SIGN-IN
┌─────────────────────────────────────────┐
│ Scan QR Code ──→ Validate Token ──┐     │
│ Enter Session Code ──────────────┤     │
│ Select from Device List ─────────┘     │
└─────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────┐
│ Student Session (JWT in localStorage)   │
└─────────────────────────────────────────┘
```

## Rationale

### Why QR Codes for Kids?

1. **Familiar:** Many schools use QR badges for lunch, library, etc.
2. **No typing:** Kids (especially young ones) struggle with keyboards
3. **Fast:** Scan and go, no friction
4. **Printable:** Parents can print a QR card for their child
5. **Secure enough:** Tied to a device, can be revoked

### Why Session Codes Too?

1. **Classroom scenarios:** Teacher generates code, writes on board
2. **No preparation:** Works without pre-printed QR codes
3. **Temporary:** Expires after class, no lingering access
4. **Kahoot-familiar:** Kids know this pattern

### Why Not Supabase Auth for Kids?

1. **COPPA:** Can't collect email from kids under 13 without parental consent
2. **Password complexity:** Kids forget passwords, get frustrated
3. **Shared devices:** Classroom tablets used by many students
4. **Simplicity:** Just scan and play

## Considered Options

### Option 1: Supabase Auth for Everyone
**Pros:**
- Single auth system
- Built-in session management

**Cons:**
- COPPA violation for young kids
- Password friction for children
- Doesn't support QR pattern

### Option 2: Custom Auth Only
**Pros:**
- Full control over flow
- Can implement any pattern

**Cons:**
- Reinventing the wheel for adults
- Security responsibility shifts to us
- No magic links, SSO, etc.

### Option 3: Hybrid Approach (Chosen)
**Pros:**
- Supabase Auth handles adult security
- Custom tokens for kid-friendly QR flow
- Best of both worlds

**Cons:**
- Two systems to maintain
- Need to sync permissions between systems

## Consequences

### Positive
- Kids can sign in without typing
- Teachers can onboard a class in seconds
- Parents have secure admin access
- COPPA compliant by design

### Negative
- Two authentication flows to maintain
- QR codes can be shared/photographed (mitigated by device binding)
- **Mitigation:** Rate limiting, device fingerprinting, parent alerts

### Neutral
- Need to build QR generation/scanning UI
- Need Edge Function for token validation

## Implementation

**Files Affected:**
- `supabase/migrations/003_authentication.sql`
- `supabase/functions/validate-student-token/index.ts` (Edge Function)
- Future: `src/components/QRScanner.tsx`, `src/components/SessionCodeEntry.tsx`

**Schema:**

```sql
-- Adult profiles (linked to Supabase Auth)
CREATE TABLE adult_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  auth_user_id UUID UNIQUE NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name TEXT NOT NULL,
  email TEXT NOT NULL,
  avatar_url TEXT,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Student authentication tokens (permanent QR codes)
CREATE TABLE student_auth_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  token_hash TEXT NOT NULL, -- SHA-256 hash of the token
  token_prefix TEXT NOT NULL, -- First 8 chars for lookup
  device_id TEXT, -- Optional: bind to specific device
  expires_at TIMESTAMPTZ, -- NULL = never expires
  last_used_at TIMESTAMPTZ,
  created_by UUID NOT NULL, -- adult_profiles.id who created it
  revoked_at TIMESTAMPTZ,
  revoked_by UUID,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(token_prefix)
);

-- Session codes (temporary classroom codes)
CREATE TABLE session_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  classroom_id UUID NOT NULL REFERENCES classrooms(id) ON DELETE CASCADE,
  code TEXT NOT NULL, -- 6-digit code, e.g., "482951"
  created_by UUID NOT NULL, -- adult_profiles.id (teacher)
  purpose TEXT, -- "math_drill", "tournament", etc.
  expires_at TIMESTAMPTZ NOT NULL,
  max_uses INTEGER, -- NULL = unlimited
  use_count INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(code) -- Codes are globally unique while active
);

-- Active student sessions
CREATE TABLE student_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  auth_method TEXT NOT NULL CHECK (auth_method IN ('qr_code', 'session_code', 'device_list')),
  auth_token_id UUID REFERENCES student_auth_tokens(id),
  session_code_id UUID REFERENCES session_codes(id),
  device_fingerprint TEXT,
  ip_address INET,
  user_agent TEXT,
  started_at TIMESTAMPTZ DEFAULT NOW(),
  last_activity_at TIMESTAMPTZ DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  CONSTRAINT auth_source CHECK (
    (auth_method = 'qr_code' AND auth_token_id IS NOT NULL) OR
    (auth_method = 'session_code' AND session_code_id IS NOT NULL) OR
    (auth_method = 'device_list')
  )
);

-- Consent tracking (COPPA compliance)
CREATE TABLE parental_consents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  parent_id UUID NOT NULL, -- adult_profiles.id
  consent_type TEXT NOT NULL CHECK (consent_type IN (
    'account_creation',
    'data_collection',
    'cross_group_friends',
    'leaderboard_display',
    'email_sharing'
  )),
  granted_at TIMESTAMPTZ DEFAULT NOW(),
  revoked_at TIMESTAMPTZ,
  ip_address INET,
  UNIQUE(student_id, consent_type)
);

-- Indexes
CREATE INDEX idx_auth_tokens_prefix ON student_auth_tokens(token_prefix) WHERE revoked_at IS NULL;
CREATE INDEX idx_session_codes_code ON session_codes(code) WHERE is_active = TRUE;
CREATE INDEX idx_student_sessions_student ON student_sessions(student_id) WHERE ended_at IS NULL;
```

**QR Code Token Format:**

```
Token: sh_<student_id_short>_<random_32_chars>
Example: sh_abc123_x7k9m2p4q8r1s5t3u6v0w2y4z8

QR Content (JSON encoded, then base64):
{
  "t": "sh_abc123_x7k9m2p4...",  // Token
  "v": 1,                         // Version
  "e": 1735689600                 // Expiry timestamp (optional)
}

Final QR: schoolhelper://auth?d=eyJ0IjoiLi4uIn0=
```

**Edge Function: validate-student-token**

```typescript
// supabase/functions/validate-student-token/index.ts
import { createClient } from '@supabase/supabase-js'

Deno.serve(async (req) => {
  const { token, device_fingerprint } = await req.json()

  // Extract prefix for lookup
  const prefix = token.substring(3, 11) // After "sh_"

  // Lookup token
  const { data: authToken } = await supabase
    .from('student_auth_tokens')
    .select('*, students(*)')
    .eq('token_prefix', prefix)
    .is('revoked_at', null)
    .single()

  if (!authToken) {
    return new Response(JSON.stringify({ error: 'Invalid token' }), { status: 401 })
  }

  // Verify full token hash
  const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(token))
  const hashHex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('')

  if (hashHex !== authToken.token_hash) {
    return new Response(JSON.stringify({ error: 'Invalid token' }), { status: 401 })
  }

  // Check expiry
  if (authToken.expires_at && new Date(authToken.expires_at) < new Date()) {
    return new Response(JSON.stringify({ error: 'Token expired' }), { status: 401 })
  }

  // Create session
  const { data: session } = await supabase
    .from('student_sessions')
    .insert({
      student_id: authToken.student_id,
      auth_method: 'qr_code',
      auth_token_id: authToken.id,
      device_fingerprint
    })
    .select()
    .single()

  // Generate JWT for client
  const jwt = await generateStudentJWT(authToken.students, session.id)

  return new Response(JSON.stringify({
    student: authToken.students,
    session_id: session.id,
    jwt
  }))
})
```

**Migration Steps:**
1. Create `adult_profiles` table with auth.users trigger
2. Create `student_auth_tokens` table
3. Create `session_codes` table
4. Create `student_sessions` table
5. Create `parental_consents` table
6. Deploy Edge Function for token validation
7. Create RLS policies

**Rollback Plan:**
- Edge Function can be rolled back instantly
- Tables can be dropped without affecting core student data
- Fallback to device-list selection (existing pattern)

## Related Decisions

- ADR-0008: Multi-Tenant Hierarchy (defines students, classrooms)
- ADR-0010: FERPA Compliance (consent requirements)
- ADR-0011: Friends System (cross-group requires consent)

## References

- [COPPA Rule](https://www.ftc.gov/legal-library/browse/rules/childrens-online-privacy-protection-rule-coppa)
- [Supabase Auth](https://supabase.com/docs/guides/auth)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)

---

**Author:** Claude (AI) + Bert Carroll
**Reviewers:** Kaland Carroll (Product Manager)
**Last Updated:** 2026-01-14
